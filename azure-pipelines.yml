# CI/CD para TP05 (Node.js: frontend + backend) + Deploy a QA

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # CI
  nodeVersion: '20.x'
  artifactNameFrontend: 'frontend'
  artifactNameBackend: 'backend'
  # CD
  azureServiceConnection: 'azure-tp05-connection'   # <— Service Connection
  webAppQa: 'webapp-tp05-qa-treachi'                # <— Web App QA
  webAppQaHost: 'webapp-tp05-qa-treachi-f4etatd8fmaydhex.eastus2-01.azurewebsites.net'  # <— Host Web App QA

stages:
# =======================
# CI: Build & Package
# =======================
- stage: Build
  displayName: 'Build & Package'
  jobs:
  - job: BuildJob
    displayName: 'Build front + package back'
    steps:
    - checkout: self

    # --- Node.js tool ---
    - task: NodeTool@0
      displayName: 'Use Node $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'

    # --- FRONTEND ---
    - script: |
        cd frontend
        npm ci
        npm run build
      displayName: 'Install & Build Frontend'

    - task: ArchiveFiles@2
      displayName: 'Archive frontend dist'
      inputs:
        rootFolderOrFile: 'frontend/dist'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        replaceExistingArchive: true

    # --- BACKEND ---
    - script: |
        set -e
        cd backend
        npm ci
        if npm run | grep -qE '^\s*build'; then
          npm run build
        fi
        cd ..
        rm -rf out_backend && mkdir -p out_backend
        rsync -av --exclude tests --exclude coverage backend/ out_backend/
      displayName: 'Install backend deps & prepare package (no node_modules)'

    - task: ArchiveFiles@2
      displayName: 'Archive backend'
      inputs:
        rootFolderOrFile: 'out_backend'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
        replaceExistingArchive: true

    # Publicar artefactos (front/back) para CD
    - task: PublishBuildArtifacts@1
      displayName: 'Publish frontend artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        ArtifactName: '$(artifactNameFrontend)'
        publishLocation: 'Container'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish backend artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend.zip'
        ArtifactName: '$(artifactNameBackend)'
        publishLocation: 'Container'

# =======================
# CD: Deploy a QA
# =======================
- stage: Deploy_QA
  displayName: 'Deploy to QA'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployBackendQA
    displayName: 'Deploy Backend + Frontend (QA)'
    environment: 'QA'   # Debe existir el Environment QA en DevOps
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none

          # ---- Descargar artefactos del build actual ----
          - task: DownloadBuildArtifacts@0
            displayName: 'Download backend artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactNameBackend)'
              downloadPath: '$(Pipeline.Workspace)/artifacts'

          - task: DownloadBuildArtifacts@0
            displayName: 'Download frontend artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactNameFrontend)'
              downloadPath: '$(Pipeline.Workspace)/artifacts'

          # ---- Extraer ZIPs a carpetas temporales ----
          - task: ExtractFiles@1
            displayName: 'Unzip backend.zip'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/artifacts/$(artifactNameBackend)/backend.zip'
              destinationFolder: '$(Pipeline.Workspace)/qa_backend'
              cleanDestinationFolder: true

          - task: ExtractFiles@1
            displayName: 'Unzip frontend.zip'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/artifacts/$(artifactNameFrontend)/frontend.zip'
              destinationFolder: '$(Pipeline.Workspace)/qa_frontend'
              cleanDestinationFolder: true

          # ---- Combinar en un solo paquete para la misma Web App ----
          # Resultado: $(Pipeline.Workspace)/deploy_qa tiene backend + dist del frontend en la raíz
          - script: |
              set -e
              mkdir -p "$(Pipeline.Workspace)/deploy_qa"
              ls -la "$(Pipeline.Workspace)/qa_backend" || true
              ls -la "$(Pipeline.Workspace)/qa_frontend" || true

              cp -a "$(Pipeline.Workspace)/qa_backend/."  "$(Pipeline.Workspace)/deploy_qa/"
              cp -a "$(Pipeline.Workspace)/qa_frontend/." "$(Pipeline.Workspace)/deploy_qa/"

              echo "Contenido final a publicar:"
              ls -la "$(Pipeline.Workspace)/deploy_qa" || true
            displayName: 'Merge backend + frontend into single package'

          # ---- Desplegar carpeta combinada a la Web App de QA ----
          - task: AzureWebApp@1
            displayName: 'Deploy merged package to QA Web App'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              appType: 'webApp'
              appName: '$(webAppQa)'
              package: '$(Pipeline.Workspace)/deploy_qa'
