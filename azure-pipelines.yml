# CI/CD para TP05 (Node.js: frontend + backend) + Deploy a QA

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # CI
  nodeVersionFrontend: '20.x'   # para Vite
  nodeVersionBackend:  '16.x' 
  artifactNameFrontend: 'frontend'
  artifactNameBackend: 'backend'
  # CD
  azureServiceConnection: 'azure-tp05-connection'
  webAppQa: 'webapp-tp05-qa-treachi'
  webAppQaHost: 'webapp-tp05-qa-treachi-f4etatd8fmaydhex.eastus2-01.azurewebsites.net'

stages:
# =======================
# CI: Build & Package
# =======================
- stage: Build
  displayName: 'Build & Package'
  jobs:
  - job: BuildJob
    displayName: 'Build front + package back'
    steps:
    - checkout: self

    # --- FRONTEND (Node 20) ---
    - task: NodeTool@0
      displayName: 'Use Node $(nodeVersionFrontend) (frontend)'
      inputs:
        versionSpec: '$(nodeVersionFrontend)'

    - script: |
        set -e
        cd frontend
        npm ci
        npm run build
        ls -la dist || true
        test -f dist/index.html
      displayName: 'Install & Build Frontend (Node 20)'

    - task: ArchiveFiles@2
      displayName: 'Archive frontend dist'
      inputs:
        rootFolderOrFile: 'frontend/dist'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        replaceExistingArchive: true

    # --- BACKEND (Node 16) ---
    - task: NodeTool@0
      displayName: 'Use Node $(nodeVersionBackend) (backend)'
      inputs:
        versionSpec: '$(nodeVersionBackend)'

    - script: |
        set -e
        cd backend
        npm ci
        if npm run | grep -qE '^\s*build'; then npm run build; fi
        cd ..
        rm -rf out_backend && mkdir -p out_backend
        rsync -av --exclude node_modules --exclude tests --exclude coverage backend/ out_backend/
        ls -la out_backend
        test -f out_backend/src/server.js
      displayName: 'Install backend deps & prepare package'

    - task: ArchiveFiles@2
      displayName: 'Archive backend'
      inputs:
        rootFolderOrFile: 'out_backend'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        ArtifactName: 'frontend'
        publishLocation: 'Container'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend.zip'
        ArtifactName: 'backend'
        publishLocation: 'Container'

# =======================
# CD: Deploy a QA
# =======================
- stage: Deploy_QA
  displayName: 'Deploy to QA'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployBackendQA
    displayName: 'Deploy Backend + Frontend (QA)'
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none

          # Node para esta stage (para poder correr npm ci en el backend)
          - task: NodeTool@0
            displayName: 'Use Node $(nodeVersionBackend) (deploy backend)'
            inputs:
              versionSpec: '$(nodeVersionBackend)'

          # ---- Descargar artefactos del build actual ----
          - task: DownloadBuildArtifacts@0
            displayName: 'Download backend artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactNameBackend)'
              downloadPath: '$(Pipeline.Workspace)/artifacts'

          - task: DownloadBuildArtifacts@0
            displayName: 'Download frontend artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactNameFrontend)'
              downloadPath: '$(Pipeline.Workspace)/artifacts'

          # ---- Extraer ZIPs a carpetas temporales ----
          - task: ExtractFiles@1
            displayName: 'Unzip backend.zip'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/artifacts/$(artifactNameBackend)/backend.zip'
              destinationFolder: '$(Pipeline.Workspace)/qa_backend'
              cleanDestinationFolder: true

          - task: ExtractFiles@1
            displayName: 'Unzip frontend.zip'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/artifacts/$(artifactNameFrontend)/frontend.zip'
              destinationFolder: '$(Pipeline.Workspace)/qa_frontend'
              cleanDestinationFolder: true

          # ---- INSTALAR DEPENDENCIAS DEL BACKEND EN LA CARPETA DE DEPLOY ----
          - script: |
              set -e
              cd "$(Pipeline.Workspace)/qa_backend"
              node -v
              npm -v
              npm ci --omit=dev
              echo "node_modules instalados en qa_backend:"
              ls -la node_modules | head -n 20 || true
            displayName: 'Install backend deps in deploy folder (npm ci --omit=dev)'

          # ---- Merge front + back en carpeta final + checks ----
          - script: |
              set -e
              mkdir -p "$(Pipeline.Workspace)/deploy_qa"

              echo "Contenido de qa_backend:"
              ls -la "$(Pipeline.Workspace)/qa_backend" || true
              echo "Contenido de qa_frontend:"
              ls -la "$(Pipeline.Workspace)/qa_frontend" || true

              # Debe existir index.html del front
              test -f "$(Pipeline.Workspace)/qa_frontend/index.html" || (echo "ERROR: falta index.html en qa_frontend (el ZIP del front está incompleto)." && exit 1)
              # Debe existir server.js del back
              test -f "$(Pipeline.Workspace)/qa_backend/src/server.js" || (echo "ERROR: falta src/server.js en qa_backend." && exit 1)

              # Merge a carpeta final
              cp -a "$(Pipeline.Workspace)/qa_backend/."  "$(Pipeline.Workspace)/deploy_qa/"
              cp -a "$(Pipeline.Workspace)/qa_frontend/." "$(Pipeline.Workspace)/deploy_qa/"

              # Forzar archivos clave en raíz publicada
              if [ -f "$(Pipeline.Workspace)/qa_backend/web.config" ]; then
                cp -f "$(Pipeline.Workspace)/qa_backend/web.config" "$(Pipeline.Workspace)/deploy_qa/web.config"
              else
                cp -f $(System.DefaultWorkingDirectory)/backend/web.config "$(Pipeline.Workspace)/deploy_qa/web.config" || true
              fi
              # (fix de ruta origen)
              [ -f "$(Pipeline.Workspace)/qa_backend/iisnode.yml" ] && cp -f "$(Pipeline.Workspace)/qa_backend/iisnode.yml" "$(Pipeline.Workspace)/deploy_qa/iisnode.yml" || true

              echo "Contenido final (deploy_qa):"
              ls -la "$(Pipeline.Workspace)/deploy_qa" || true

              # Checks finales
              test -f "$(Pipeline.Workspace)/deploy_qa/web.config" || (echo "ERROR: falta web.config" && exit 1)
              test -f "$(Pipeline.Workspace)/deploy_qa/src/server.js" || (echo "ERROR: falta src/server.js" && exit 1)
              test -f "$(Pipeline.Workspace)/deploy_qa/index.html" || (echo "ERROR: falta index.html (frontend)" && exit 1)
              test -d "$(Pipeline.Workspace)/deploy_qa/node_modules" || (echo "ERROR: falta node_modules en deploy_qa (no se instalaron deps del backend)." && exit 1)
            displayName: 'Merge + checks + web.config'

          # ---- Crear ZIP final para deploy ----
          - task: ArchiveFiles@2
            displayName: 'Zip final deploy_qa'
            inputs:
              rootFolderOrFile: '$(Pipeline.Workspace)/deploy_qa'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Pipeline.Workspace)/deploy_qa.zip'
              replaceExistingArchive: true

          # ---- Desplegar el ZIP final a la Web App de QA ----
          - task: AzureWebApp@1
            displayName: 'Deploy merged ZIP to QA Web App'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              appType: 'webApp'
              appName: '$(webAppQa)'
              package: '$(Pipeline.Workspace)/deploy_qa.zip'
