# CI/CD para TP05 (Node.js: frontend + backend) + Deploy a QA

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # CI
  nodeVersion: '20.x'
  artifactNameFrontend: 'frontend'
  artifactNameBackend: 'backend'
  # CD
  azureServiceConnection: 'azure-tp05-connection'
  webAppQa: 'webapp-tp05-qa-treachi'
  webAppQaHost: 'webapp-tp05-qa-treachi-f4etatd8fmaydhex.eastus2-01.azurewebsites.net'

stages:
# =======================
# CI: Build & Package
# =======================
- stage: Build
  displayName: 'Build & Package'
  jobs:
  - job: BuildJob
    displayName: 'Build front + package back'
    steps:
    - checkout: self

    # --- Node.js tool ---
    - task: NodeTool@0
      displayName: 'Use Node $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'

    # --- FRONTEND ---
    - script: |
        set -e
        cd frontend
        npm ci
        npm run build
        echo "Contenido de frontend/dist:"
        ls -la dist || true
        test -f dist/index.html || (echo "ERROR: No existe dist/index.html. Falló el build de Vite." && exit 1)
      displayName: 'Install & Build Frontend (con verificación)'

    - task: ArchiveFiles@2
      displayName: 'Archive frontend dist'
      inputs:
        rootFolderOrFile: 'frontend/dist'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        replaceExistingArchive: true

    # --- BACKEND ---
    - script: |
        set -e
        cd backend
        npm ci
        # Si existe un script build, ejecutarlo
        if npm run | grep -qE '^\s*build'; then
          npm run build
        fi
        cd ..
        # Preparar carpeta limpia sin node_modules/tests/coverage
        rm -rf out_backend && mkdir -p out_backend
        rsync -av \
          --exclude node_modules \
          --exclude tests \
          --exclude coverage \
          backend/ out_backend/
        echo "Contenido de out_backend:"
        ls -la out_backend || true
        # Checks mínimos
        test -f out_backend/web.config || (echo "ADVERTENCIA: no se encontró backend/web.config (se copiará luego igualmente)")
        test -f out_backend/src/server.js || (echo "ERROR: falta backend/src/server.js" && exit 1)
      displayName: 'Install backend deps & prepare package (no node_modules)'

    - task: ArchiveFiles@2
      displayName: 'Archive backend'
      inputs:
        rootFolderOrFile: 'out_backend'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
        replaceExistingArchive: true

    # Publicar artefactos (front/back) para CD
    - task: PublishBuildArtifacts@1
      displayName: 'Publish frontend artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        ArtifactName: '$(artifactNameFrontend)'
        publishLocation: 'Container'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish backend artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend.zip'
        ArtifactName: '$(artifactNameBackend)'
        publishLocation: 'Container'

# =======================
# CD: Deploy a QA
# =======================
- stage: Deploy_QA
  displayName: 'Deploy to QA'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployBackendQA
    displayName: 'Deploy Backend + Frontend (QA)'
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none

          # ---- Descargar artefactos del build actual ----
          - task: DownloadBuildArtifacts@0
            displayName: 'Download backend artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactNameBackend)'
              downloadPath: '$(Pipeline.Workspace)/artifacts'

          - task: DownloadBuildArtifacts@0
            displayName: 'Download frontend artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactNameFrontend)'
              downloadPath: '$(Pipeline.Workspace)/artifacts'

          # ---- Extraer ZIPs a carpetas temporales ----
          - task: ExtractFiles@1
            displayName: 'Unzip backend.zip'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/artifacts/$(artifactNameBackend)/backend.zip'
              destinationFolder: '$(Pipeline.Workspace)/qa_backend'
              cleanDestinationFolder: true

          - task: ExtractFiles@1
            displayName: 'Unzip frontend.zip'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/artifacts/$(artifactNameFrontend)/frontend.zip'
              destinationFolder: '$(Pipeline.Workspace)/qa_frontend'
              cleanDestinationFolder: true

          # ---- Merge front + back en carpeta final + checks ----
          - script: |
              set -e
              mkdir -p "$(Pipeline.Workspace)/deploy_qa"

              echo "Contenido de qa_backend:"
              ls -la "$(Pipeline.Workspace)/qa_backend" || true
              echo "Contenido de qa_frontend:"
              ls -la "$(Pipeline.Workspace)/qa_frontend" || true

              # Debe existir index.html del front
              test -f "$(Pipeline.Workspace)/qa_frontend/index.html" || (echo "ERROR: falta index.html en qa_frontend (el ZIP del front está incompleto)." && exit 1)
              # Debe existir server.js del back
              test -f "$(Pipeline.Workspace)/qa_backend/src/server.js" || (echo "ERROR: falta src/server.js en qa_backend." && exit 1)

              # Merge a carpeta final
              cp -a "$(Pipeline.Workspace)/qa_backend/."  "$(Pipeline.Workspace)/deploy_qa/"
              cp -a "$(Pipeline.Workspace)/qa_frontend/." "$(Pipeline.Workspace)/deploy_qa/"

              # Forzar archivos clave en raíz publicada
              if [ -f "$(Pipeline.Workspace)/qa_backend/web.config" ]; then
                cp -f "$(Pipeline.Workspace)/qa_backend/web.config" "$(Pipeline.Workspace)/deploy_qa/web.config"
              else
                # Copia desde el repo (ruta relativa al workspace del agente al ejecutar)
                cp -f $(System.DefaultWorkingDirectory)/backend/web.config "$(Pipeline.Workspace)/deploy_qa/web.config" || true
              fi
              [ -f "$(Pipeline.Workspace)/qa_backend/iisnode.yml" ] && cp -f "$(Pipeline.Workspace)/deploy_qa/iisnode.yml" "$(Pipeline.Workspace)/deploy_qa/iisnode.yml" || true

              echo "Contenido final (deploy_qa):"
              ls -la "$(Pipeline.Workspace)/deploy_qa" || true

              # Checks finales
              test -f "$(Pipeline.Workspace)/deploy_qa/web.config" || (echo "ERROR: falta web.config" && exit 1)
              test -f "$(Pipeline.Workspace)/deploy_qa/src/server.js" || (echo "ERROR: falta src/server.js" && exit 1)
              test -f "$(Pipeline.Workspace)/deploy_qa/index.html" || (echo "ERROR: falta index.html (frontend)" && exit 1)
            displayName: 'Merge + checks + web.config'

          # ---- Crear ZIP final para deploy ----
          - task: ArchiveFiles@2
            displayName: 'Zip final deploy_qa'
            inputs:
              rootFolderOrFile: '$(Pipeline.Workspace)/deploy_qa'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Pipeline.Workspace)/deploy_qa.zip'
              replaceExistingArchive: true

          # ---- Desplegar el ZIP final a la Web App de QA ----
          - task: AzureWebApp@1
            displayName: 'Deploy merged ZIP to QA Web App'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              appType: 'webApp'
              appName: '$(webAppQa)'
              package: '$(Pipeline.Workspace)/deploy_qa.zip'
